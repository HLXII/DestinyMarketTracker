<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Duru+Sans&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <title>Destiny.gg Market Tracker</title>
    <style>
        html {
            overflow: hidden;
        }
        html,body{
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: bold;
        }
        body{
            background-color: #181818;
            display: flex;
        }
        .markets {
            height: 100%;
            min-width: fit-content;
            width: 25%;
            flex: 1;
        }
        .tracker {
            height: 100%;
            width: 75%;
        }
        .currentMarkets {
            padding-left: 15px;
            padding-top: 60px;
        }

        .floating-tooltip-2 {
        	width: 96px;
        	height: 80px;
        	position: absolute;
        	display: none;
        	padding: 8px;
        	box-sizing: border-box;
        	font-size: 12px;
        	color: #131722;
        	background-color: rgba(255, 255, 255, 1);
        	text-align: left;
        	z-index: 1000;
        	top: 12px;
        	left: 12px;
        	pointer-events: none;
        	border: 1px solid rgba(255, 70, 70, 1);
        	border-radius: 2px;
        }


        .noselect {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
             -khtml-user-select: none; /* Konqueror HTML */
               -moz-user-select: none; /* Old versions of Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome, Edge, Opera and Firefox */
        }

        .dropdown-menu {
            overflow-y: scroll;
            max-height: 80vh;
        }

        p {
            padding-top: 5px;
            color : white;
            font-size: 12px;
            font-weight: 2500;
        }
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XX3YRT498Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XX3YRT498Y');
</script>

<body>
    <div class="markets">
        <div class="container" style="width:100%;height:85px;padding-top:2vh;">
            <div class="dropdown show">
                <a class="btn btn-secondary dropdown-toggle bg-dark" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select Stocks
                </a>
              
                <div class="dropdown-menu" aria-labelledby="dropdownMenuLink"></div>
                <p>Powered by : <a target="_blank" href="https://manifold.markets/memestiny">https://manifold.markets/memestiny</a><br>Created by : <a target="_blank" href="https://www.youtube.com/embed/rRPQs_kM_nw?autoplay=1">legolas</a> + <a href="https://i.kym-cdn.com/photos/images/newsfeed/001/207/210/b22.jpg">blerch</a></p>
            </div>
        </div>
        <ul class="currentMarkets">

        </ul>
    </div>
    <div class="tracker"></div>
    <script>
        let currentMarkets = new Map();
        let allMarkets = new Map();

        function generateRandomColorRgba() {
            const red = Math.floor(Math.random() * (225 - 100) + 100);
            const green = Math.floor(Math.random() *  (225 - 100) + 100);
            const blue = Math.floor(Math.random() *  (225 - 100) + 100);
            return {red, green, blue}
        }           

        async function getMarkets(){
            let markets = await fetch("https://manifold.markets/api/v0/group/by-id/W2ES30fRo6CCbPNwMTTj/markets").then(_=>_.json())

            markets = markets.filter(market=>{
                return ( market.creatorId == "lQdCwuc1OrZLUqgA4EwjPSSwG5Z2" && market.question.includes("(Permanent)") )
            })

            markets = markets.map(market => {
                let color = generateRandomColorRgba();
                return {
                    name : market.question.replace("(Permanent)",""),
                    id : market.id,
                    color : color,
                    colorText : `rgba(${color.red}, ${color.green}, ${color.blue}, .95)`,
                    price : 0
                }
            })

            markets.forEach(market => {
                allMarkets.set(market.id, market)
            })
            return markets
        }

        async function getPrice(marketId){
            return (await fetch(`https://manifold.markets/api/v0/market/${marketId}`).then(_=>_.json())).probability * 100
        }

        function rand(min, max) {
            return min + Math.random() * (max - min);
        }


        $('.dropdown-toggle').dropdown()

        const chart = LightweightCharts.createChart(document.querySelector(".tracker"),
            {
                layout: {
	            		backgroundColor: 'rgb(34, 34, 34)',
	            		lineColor: '#2B2B43',
	            		textColor: '#D9D9D9',
	            },
	            watermark: {
		            visible: true,
		            fontSize: 65,
		            horzAlign: 'center',
		            vertAlign: 'center',
		            color: 'rgba(64, 64, 64, .6)',
		            text: 'DGG.EXCHANGE',
	            },
	            crosshair: {
	            	color: '#758696',
	            },
	            grid: {
	            	vertLines: {
	            		color: '#2B2B43',
	            	},
	            	horzLines: {
	            		color: '#363C4E',
	            	},
	            },
                timeScale: {
		            visible: false,
	            },
            }
        ); 

        new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== document.querySelector(".tracker")) { return; }
                const newRect = entries[0].contentRect;
                chart.applyOptions({ height: newRect.height, width: newRect.width });
        }).observe(document.querySelector(".tracker"));

        (async () => {
            let markets = await getMarkets();
            let dropdownMenu = document.querySelector(".dropdown-menu");
            let currentMarketHolder = document.querySelector(".currentMarkets");


            markets.forEach(market => {
                let el = document.createElement("a")
                el.className = "dropdown-item stock-ticker"
                el.dataset.ticker = getTicker(market.name) // Blerch
                el.innerHTML = market.name
                el.href = "#"

                let marketHolder = document.createElement("li");
                marketHolder.id = `market-holder-${getTicker(market.name)}`;// Blerch
                marketHolder.dataset.id = market.id
                marketHolder.style = `
                    display:none;
                    color:white;
                    float : left;
                    clear: left;
                    margin-right: 15px;
                `;
                let marketEl = document.createElement("span");
                marketEl.innerHTML = market.name;

                let colorKey = document.createElement("span")
                colorKey.style = `
                    margin-bottom: 2px;
                    width: 12px; 
                    height: 12px;
                    background-color : ${market.colorText};
                    border-radius : 10px;
                    display:inline-block;
                    vertical-align:middle;
                `;

                marketHolder.appendChild(marketEl)
                marketHolder.appendChild(colorKey)
                currentMarketHolder.appendChild(marketHolder)

                el.onclick = () => {
                    if(currentMarkets.has(market.id)){
                        currentMarkets.delete(market.id);
                        marketHolder.style.display = "none";
                        el.classList.remove("active")
                        chart.removeSeries(market.series)
                    }else{
                        currentMarkets.set(market.id, market)
                        marketHolder.style.display = "table";
                        el.classList.add("active")
                        market.series = chart.addAreaSeries({
                          topColor: 'rgba(0, 0, 0, 0)',
                          bottomColor: 'rgba(0, 0, 0, 0)',
                          lineColor: market.colorText,
                          lineWidth: 2,
                        });
                        window.test = market.series
                    }
                }

                marketEl.onmouseover  = () => {
                    if (market.series){
                        market.series.applyOptions({
                            topColor: 'rgba(0, 0, 0, 0)',
                            bottomColor: 'rgba(0, 0, 0, 0)',
                            lineColor: `rgba(${market.color.red + 30}, ${market.color.green + 30}, ${market.color.blue + 30}, .95)`,
                            lineWidth: 5,
                        })
                    }
                }

                marketEl.onmouseout  = () => {
                    if (market.series){
                        market.series.applyOptions({
                            topColor: 'rgba(0, 0, 0, 0)',
                            bottomColor: 'rgba(0, 0, 0, 0)',
                            lineColor: market.colorText,
                            lineWidth: 2,
                        })  
                    }
                    
                }

                dropdownMenu.appendChild(el)
            });

            setInterval(async () => {
                currentMarkets.forEach(async (market) => {
                    if(market.series){
                        let price = await getPrice(market.id);
                        market.price = price;
                        market.series.update({
                            time : Date.now(),
                            value : price
                        })
                        allMarkets.set(market.id, market)
                    }
                })

                // sorting
                let newList = document.querySelector(".currentMarkets").cloneNode(false);
                let currentMarketList = [].slice.call(document.querySelector(".currentMarkets").children);
                currentMarketList.sort((a,b) => {
                    return allMarkets.get(b.dataset.id).price - allMarkets.get(a.dataset.id).price
                })
                for(var i = 0; i < currentMarketList.length; i++)
                    newList.appendChild(currentMarketList[i]);
                document.querySelector(".currentMarkets").parentNode.replaceChild(newList, document.querySelector(".currentMarkets"))

            }, 250);

            // Blerch
            addTickerEventListener();
            setTickerAssociation(markets); 

        })();

        

        //#region Blerch

        let market_string = window.location.hash;
        if(market_string.indexOf('#') === 0)
            market_string = market_string.substring(1);

        let markets = market_string.split('+');
        let supportedMarkets = new Map();

        const getTicker = (name, length = 3) => {
            let n = name.substr(0, length).trim();
            if(supportedMarkets.has(n)) {
                return getTicker(name, length + 1);
            } else {
                return n.toUpperCase();
            }
        }

        const setTickerAssociation = (output) => {
            for(let i = 0; i < output.length; i++) {
                let ticker = getTicker(output[i].name);
                supportedMarkets.set(ticker, output[i]);
            }

            //console.log(supportedMarkets);
            addStockByTicker(...markets);
        }

        const clearStocks = () => {
            let stocks = Array.from(currentMarkets.values());
            stocks.forEach((stock) => {
                //console.log(stock);
                let mh = document.getElementById(`market-holder-${getTicker(stock.name)}`);
                if(mh instanceof Element)
                    mh.style.display = "none";

                chart.removeSeries(stock.series);                 
                currentMarkets.delete(stock.delete);
            });

            currentMarkets = new Map();
        }
        
        const addStockByTicker = (...tickers) => {
            tickers.forEach((ticker) => {
                let market = supportedMarkets.get(ticker.toUpperCase());
                //console.log(ticker, "Market", market);

                if(market == undefined)
                    return;
    
                let marketHolder = document.getElementById(`market-holder-${getTicker(market.name)}`);
                if(currentMarkets.has(market.id)){
                    currentMarkets.delete(market.id);
                    marketHolder.style.display = "none";
                    let el = document.querySelector(`[data-ticker='${getTicker(market.name)}']`)
                    el.classList.remove("active")
                    chart.removeSeries(market.series)
                } else {
                    currentMarkets.set(market.id, market)
                    marketHolder.style.display = "table";
                    let el = document.querySelector(`[data-ticker='${getTicker(market.name)}']`)
                    el.classList.add("active")
                    market.series = chart.addAreaSeries({
                        topColor: 'rgba(0, 0, 0, 0)',
                        bottomColor: 'rgba(0, 0, 0, 0)',
                        lineColor: market.colorText,
                        lineWidth: 2,
                        symbol : market.name
                    });
                }
            });
        }

        const addTickerEventListener = () => {
            let elems = [...document.getElementsByClassName('stock-ticker')];
            elems.forEach((elem) => {
                elem.addEventListener('click', (e) => {
                    e.preventDefault();
                    setTimeout(() => {
                        let _markets = Array.from(currentMarkets.values()).map((tik) => getTicker(tik.name)).join('+');
                        //console.log(_markets, e.target.dataset.ticker);
                        window.history.pushState({ "markets": _markets}, "", `#${_markets}`);
                    }, 100)
                });
            });

            window.onpopstate = (e) => {
                //console.log("popping state", e.state);
                if(e.state) {
                    e.preventDefault();
                    clearStocks();
                    addStockByTicker(...e.state.markets.split('+'));
                }
            }
        }

        //#endregion
    </script>
</body>
</html>
