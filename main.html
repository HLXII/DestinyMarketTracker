<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Duru+Sans&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <title>Destiny.gg Market Tracker</title>
    <style>
        html,body{
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: bold;
        }
        body{
            background-color: #181818;
            display: flex;
        }
        .markets {
            height: 100%;
            width: 25%;
            flex: 1;
        }
        .tracker {
            height: 100%;
            width: 75%;
        }
        .currentMarkets {
            padding-left: 15px;
            padding-top: 60px;
        }

        .noselect {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
             -khtml-user-select: none; /* Konqueror HTML */
               -moz-user-select: none; /* Old versions of Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome, Edge, Opera and Firefox */
        }

        p {
            padding-top: 5px;
            color : white;
            font-size: 12px;
            font-weight: 2500;
        }
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XX3YRT498Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XX3YRT498Y');
</script>

<body>
    <div class="markets">
        <div class="container" style="width:100%;height:85px;padding-top:2vh;">
            <div class="dropdown show">
                <a class="btn btn-secondary dropdown-toggle bg-dark" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select Stocks
                </a>
              
                <div class="dropdown-menu" aria-labelledby="dropdownMenuLink"></div>
                <p>Powered by : <a target="_blank" href="https://manifold.markets/memestiny">https://manifold.markets/memestiny</a><br>Created by : <a target="_blank" href="https://www.youtube.com/embed/rRPQs_kM_nw?autoplay=1">legolas</a></p>
            </div>
        </div>
        <ul class="currentMarkets">

        </ul>
    </div>
    <div class="tracker"></div>
    <script>
        let currentMarkets = new Map();

        function generateRandomColorRgba() {
            const red = Math.floor(Math.random() * (256 - 100) + 100);
            const green = Math.floor(Math.random() *  (256 - 100) + 100);
            const blue = Math.floor(Math.random() *  (256 - 100) + 100);
            return "rgba(" + red + ", " + green + ", " + blue + ", .95)";
        }           

        async function getMarkets(){
            let markets = await fetch("https://manifold.markets/api/v0/group/by-id/W2ES30fRo6CCbPNwMTTj/markets").then(_=>_.json())

            markets = markets.filter(market=>{
                return ( market.creatorId == "lQdCwuc1OrZLUqgA4EwjPSSwG5Z2" && market.question.includes("(Permanent)") )
            })

            markets = markets.map(market => {
                return {
                    name : market.question.replace("(Permanent)",""),
                    id : market.id,
                    color : generateRandomColorRgba()
                }
            })
            return markets
        }

        async function getPrice(marketId){
            return (await fetch(`https://manifold.markets/api/v0/market/${marketId}`).then(_=>_.json())).probability * 100
        }

        function rand(min, max) {
            return min + Math.random() * (max - min);
        }


        $('.dropdown-toggle').dropdown()

        const chart = LightweightCharts.createChart(document.querySelector(".tracker"),
            {
                layout: {
	            		backgroundColor: 'rgb(34, 34, 34)',
	            		lineColor: '#2B2B43',
	            		textColor: '#D9D9D9',
	            },
	            watermark: {
	            	color: 'rgba(0, 0, 0, 0)',
	            },
	            crosshair: {
	            	color: '#758696',
	            },
	            grid: {
	            	vertLines: {
	            		color: '#2B2B43',
	            	},
	            	horzLines: {
	            		color: '#363C4E',
	            	},
	            },
                timeScale: {
		            visible: false,
	            },
            }
        );

        new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== document.querySelector(".tracker")) { return; }
                const newRect = entries[0].contentRect;
                chart.applyOptions({ height: newRect.height, width: newRect.width });
        }).observe(document.querySelector(".tracker"));

        (async () => {
            let markets = await getMarkets();
            let dropdownMenu = document.querySelector(".dropdown-menu");
            let currentMarketHolder = document.querySelector(".currentMarkets");


            markets.forEach(market => {
                let el = document.createElement("a")
                el.className = "dropdown-item"
                el.innerHTML = market.name
                el.href = "#"

                let marketHolder = document.createElement("li");
                marketHolder.style = `
                    display:none;
                    color:white;
                    float : left;
                    clear: left;
                    margin-right: 15px;
                `;
                let marketEl = document.createElement("span");
                marketEl.innerHTML = market.name;

                let colorKey = document.createElement("span")
                colorKey.style = `
                    margin-bottom: 2px;
                    width: 12px; 
                    height: 12px;
                    background-color : ${market.color};
                    border-radius : 10px;
                    display:inline-block;
                    vertical-align:middle;
                `;

                marketHolder.appendChild(marketEl)
                marketHolder.appendChild(colorKey)
                currentMarketHolder.appendChild(marketHolder)

                el.onclick = () => {
                    if(currentMarkets.has(market.id)){
                        currentMarkets.delete(market.id);
                        marketHolder.style.display = "none";
                        el.classList.remove("active")
                        chart.removeSeries(market.series)
                    }else{
                        currentMarkets.set(market.id, market)
                        marketHolder.style.display = "table";
                        el.classList.add("active")
                        market.series = chart.addAreaSeries({
                          topColor: 'rgba(0, 0, 0, 0)',
                          bottomColor: 'rgba(0, 0, 0, 0)',
                          lineColor: market.color,
                          lineWidth: 2,
                        });
                    }
                }
                dropdownMenu.appendChild(el)
            });

            setInterval(async () => {
                currentMarkets.forEach(async (market) => {
                    let price = await getPrice(market.id);
                    market.series.update({
                        time : Date.now(),
                        value : price
                    })
                })
            }, 250)

        })();
    </script>
</body>
</html>
